pipeline {
 agent any
 stages {
  stage ('compile the application') {
   steps {
    sh 'mvn compile'
   }
  }
  stage ('Generate War package') {
   steps {
    sh 'mvn package'
   }
  }
  stage ('create docker image') {
   steps {
    sh 'sudo docker build -t devopsxprts/addressbook:20210928.$BUILD_NUMBER .'
   }
  }
  stage ('upload image to docker registry') {
   steps {
    withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'pass', usernameVariable: 'user')]) {
     sh '''
           sudo docker login --username $user --password $pass
           sudo docker push devopsxprts/addressbook:20210928.$BUILD_NUMBER
        '''
    }
   }   
  }
  stage ('update kubernetes deployment') {
   steps {
    sh 'kubectl set image deployment addressbook devopsxprts/addressbook=addressbook:20210928.$BUILD_NUMBER'
   }
  }
 }
}
